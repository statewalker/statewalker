<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <script type="text/javascript" src="./dist/statewalker.tree.js"></script>
    <script type="text/javascript" src="./dist/statewalker.fsm.js"></script>
    <script type="text/javascript">
        const descriptor = {
          "transitions": [
            { "from" : "", "event" : "*", "to" : "LOGIN" },
            { "from" : "LOGIN", "event" : "ok", "to" : "MAIN_VIEW" },
            { "from" : "MAIN_VIEW", "event" : "*", "to" : "MAIN_VIEW" },
            { "from" : "MAIN_VIEW", "event" : "logout", "to" : "LOGIN" }
          ],
          "states": [
            {
              "key": "LOGIN",
              "transitions": [
                { "from" : "", "event" : "*", "to" : "FORM" }
              ]
            },
            {
              "key": "MAIN_VIEW",
              "transitions": [
                { "from" : "*", "event" : "*", "to" : "PAGE_VIEW" },
                { "from" : "*", "event" : "logout", "to" : "" },
                { "from" : "PAGE_VIEW", "event" : "edit", "to" : "PAGE_EDIT" },
                { "from" : "PAGE_EDIT", "event" : "ok", "to" : "PAGE_UPDATED_MESSAGE" }
              ],
              "states": [
                {
                  "key": "PAGE_EDIT",
                  "transitions": [
                    { "from" : "", "event" : "*", "to" : "FORM" }
                  ]
                }
              ]
            },
            {
              "key": "FORM",
              "transitions": [
                { "from" : "", "event" : "*", "to" : "SHOW_FORM" },
                { "from" : "SHOW_FORM", "event" : "*", "to" : "VALIDATE_FORM" },
                { "from" : "SHOW_FORM", "event" : "cancel", "to" : "" },
                { "from" : "VALIDATE_FORM", "event" : "ok", "to" : "" },
                { "from" : "VALIDATE_FORM", "event" : "*", "to" : "SHOW_FORM_ERRORS" },
                { "from" : "SHOW_FORM_ERRORS", "event" : "*", "to" : "SHOW_FORM" },
                { "from" : "SHOW_FORM_ERRORS", "event" : "cancel", "to" : "" }
              ]
            }
          ]
        }
        const print = (state, msg) => {
          let shift = '';
          while (state) {
            state = state.parent;
            shift += '  ';
          }
          console.log(shift + msg);
        }
        const getPath = (parent, state) => {
          return state ? state.path : parent ? parent.path + '/' : '';
        }
        const process = new statewalker.fsm.FsmProcess({
          descriptor : statewalker.fsm.FsmConfig.buildDescriptor(descriptor),
          transition({ parent, prev, event, next }) {
            const getKey = (s, d='') => (s ? s.path || s.key : d);
            const transitions = prev ? prev.getTransitions() : {};
            const nextPath = getPath(parent, next);
            const nextKey = next ? next.path : '';
            const eventKey = getKey(event);
            for (let transitionEventKey of Object.keys(transitions).sort()) {
              let targetPath = transitions[transitionEventKey];
              let ev = transitionEventKey;
              if (targetPath === nextPath) {
                if (transitionEventKey !== eventKey) {
                  ev = `${ev}=${eventKey}`;
                }
                ev = `[${ev}]`;
              }
              // print(parent, ` -${ev}-> ${targetPath}`);
            }
            // print(parent, `${getKey(prev, '*')}(${JSON.stringify(transitions)}) =[${getKey(event)}]=> ${getKey(next, 'x')}`);
          },
          before(state) {
            print(state, `<${state.key} event="${process.event.key}">`);
          },
          after(state) {
            print(state, `</${state.key}>`);
          }
        });


        const events = [
          // Login session
          'submit', 'error', 'ok', 'submit', 'ok',
          // Main state
          'tto',
          // Edit
          'edit', 'submit', 'ok',
          // Close the result message
          'ok',
          // Exit from the main view
           'logout'
        ];

        let i = 0;
        for (let s of process.run()) {
          if (i >= events.length) break;
          const prevEvent = events[i++];
          print(s, `Emit event: [${prevEvent}]`);
          process.setEvent(prevEvent);
        }
    </script>
  </body>
</html>
